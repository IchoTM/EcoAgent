{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h2>Your Sustainability Analytics</h2>
    <p class="lead">Compare your environmental impact with U.S. national averages</p>

    <div class="chart-grid">
        <div class="chart-card">
            <h3>Energy Consumption</h3>
            <p class="chart-description">Monthly household energy usage (kWh)</p>
            <div id="energy-chart" class="chart"></div>
        </div>

        <div class="chart-card">
            <h3>Water Usage</h3>
            <p class="chart-description">Monthly water consumption (Gallons)</p>
            <div id="water-chart" class="chart"></div>
        </div>

        <div class="chart-card">
            <h3>Transportation Impact</h3>
            <p class="chart-description">Monthly miles traveled</p>
            <div id="transport-chart" class="chart"></div>
        </div>

        <div class="chart-card">
            <h3>Carbon Footprint</h3>
            <p class="chart-description">Monthly CO2 emissions (lbs)</p>
            <div id="carbon-chart" class="chart"></div>
        </div>
    </div>
    
    <!-- Cost Savings Analysis -->
    <div class="cost-savings-container">
        <h2>Cost Savings Analysis</h2>
        <div class="savings-grid">
            <!-- Electricity Savings -->
            <div class="savings-card electricity">
                <h3>Electricity Cost</h3>
                <p>Your Monthly Cost: ${{ "%.2f"|format(user_costs.electricity) }}</p>
                <p>Average US Cost: ${{ "%.2f"|format(avg_costs.electricity) }}</p>
                <div class="savings {{ 'positive' if cost_savings.electricity > 0 else 'negative' }}">
                    {% if cost_savings.electricity > 0 %}
                        Saving ${{ "%.2f"|format(cost_savings.electricity) }}
                    {% else %}
                        Spending ${{ "%.2f"|format(cost_savings.electricity|abs) }} more
                    {% endif %}
                </div>
            </div>
            
            <!-- Water Savings -->
            <div class="savings-card water">
                <h3>Water Cost</h3>
                <p>Your Monthly Cost: ${{ "%.2f"|format(user_costs.water) }}</p>
                <p>Average US Cost: ${{ "%.2f"|format(avg_costs.water) }}</p>
                <div class="savings {{ 'positive' if cost_savings.water > 0 else 'negative' }}">
                    {% if cost_savings.water > 0 %}
                        Saving ${{ "%.2f"|format(cost_savings.water) }}
                    {% else %}
                        Spending ${{ "%.2f"|format(cost_savings.water|abs) }} more
                    {% endif %}
                </div>
            </div>
            
            <!-- Transportation Savings -->
            <div class="savings-card transport">
                <h3>Transportation Cost</h3>
                <p>Your Monthly Cost: ${{ "%.2f"|format(user_costs.transport) }}</p>
                <p>Average US Cost: ${{ "%.2f"|format(avg_costs.transport) }}</p>
                <div class="savings {{ 'positive' if cost_savings.transport > 0 else 'negative' }}">
                    {% if cost_savings.transport > 0 %}
                        Saving ${{ "%.2f"|format(cost_savings.transport) }}
                    {% else %}
                        Spending ${{ "%.2f"|format(cost_savings.transport|abs) }} more
                    {% endif %}
                </div>
            </div>
            
            <!-- Total Savings -->
            <div class="savings-card total">
                <h3>Total Monthly Impact</h3>
                <p>Your Total Cost: ${{ "%.2f"|format(total_user_cost) }}</p>
                <p>Average US Cost: ${{ "%.2f"|format(total_avg_cost) }}</p>
                <div class="savings {{ 'positive' if total_savings > 0 else 'negative' }}">
                    {% if total_savings > 0 %}
                        Total Savings: ${{ "%.2f"|format(total_savings) }}
                    {% else %}
                        Additional Costs: ${{ "%.2f"|format(total_savings|abs) }}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Annual Projection -->
        <div class="annual-projection">
            <h3>Annual Projection</h3>
            <p>
                {% if total_savings > 0 %}
                    At this rate, you could save <span class="highlight-savings positive">${{ "%.2f"|format(total_savings * 12) }}</span> per year!
                {% else %}
                    By reaching average US consumption levels, you could save up to <span class="highlight-savings negative">${{ "%.2f"|format(total_savings|abs * 12) }}</span> per year.
                {% endif %}
            </p>
        </div>
        
        <!-- AI Insights Section -->
        <div class="ai-insights">
            <h2>AI Insights & Recommendations</h2>
            <div class="insights-grid">
                <!-- Electricity Insights -->
                <div class="insight-card {% if insights.electricity.above_average %}needs-improvement{% else %}good{% endif %}">
                    <h3>
                        <i class="fas fa-bolt"></i>
                        Electricity Usage
                    </h3>
                    <ul>
                        {% for tip in insights.electricity.tips %}
                            <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Water Insights -->
                <div class="insight-card {% if insights.water.above_average %}needs-improvement{% else %}good{% endif %}">
                    <h3>
                        <i class="fas fa-water"></i>
                        Water Usage
                    </h3>
                    <ul>
                        {% for tip in insights.water.tips %}
                            <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Transportation Insights -->
                <div class="insight-card {% if insights.transport.above_average %}needs-improvement{% else %}good{% endif %}">
                    <h3>
                        <i class="fas fa-car"></i>
                        Transportation Impact
                    </h3>
                    <ul>
                        {% for tip in insights.transport.tips %}
                            <li>{{ tip }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Energy Chart
    const energyData = {
        userValue: {{ user_energy }},
        nationalAvg: 877, // Average US household uses ~877 kWh per month
        title: 'Energy Consumption (kWh/month)'
    };
    createComparisonChart('energy-chart', energyData);

    // Water Chart
    const waterData = {
        userValue: {{ user_water }},
        nationalAvg: 8800, // Average US household uses ~8,800 gallons per month
        title: 'Water Usage (Gallons/month)'
    };
    createComparisonChart('water-chart', waterData);

    // Transportation Chart
    const transportData = {
        userValue: {{ user_miles }},
        nationalAvg: 1200, // Average US household drives ~1,200 miles per month
        title: 'Miles Traveled per Month'
    };
    createComparisonChart('transport-chart', transportData);

    // Carbon Footprint Chart
    const carbonData = {
        userValue: {{ user_carbon }},
        nationalAvg: 2666.67, // 16 tons/year = 32000 lbs/year = 2666.67 lbs/month
        title: 'CO2 Emissions (lbs/month)'
    };
    createComparisonChart('carbon-chart', carbonData);
});

function createComparisonChart(elementId, data) {
    const trace1 = {
        x: ['Your Usage', 'U.S. Average'],
        y: [data.userValue, data.nationalAvg],
        type: 'bar',
        marker: {
            color: ['#34D399', '#64748B']
        }
    };

    const layout = {
        title: data.title,
        height: 300,
        margin: { t: 40, r: 20, l: 40, b: 40 },
        font: {
            family: 'Inter, sans-serif'
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        bargap: 0.3
    };

    Plotly.newPlot(elementId, [trace1], layout, {responsive: true});
}
</script>
{% endblock %}
