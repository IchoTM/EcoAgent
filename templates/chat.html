{% extends "base.html" %}

{% block title %}EcoAgent Chat{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <div class="chat-header-content">
            <div class="chat-title">
                <i class="fas fa-leaf chat-icon"></i>
                <h2>EcoAgent Chat</h2>
            </div>
            <p>Your AI Sustainability Assistant</p>
        </div>
    </div>
    
    <div class="chat-messages" id="chat-messages">
        <div class="message assistant">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="message-header">
                    <span class="message-sender">EcoAgent</span>
                    <span class="message-time">just now</span>
                </div>
                <div class="message-text">
                    ðŸ‘‹ Hello! I'm your EcoAgent AI assistant. I'm here to help you understand your environmental impact and discover personalized ways to live more sustainably. What would you like to know about?
                </div>
            </div>
        </div>
    </div>
    
    <div class="chat-input-wrapper">
        <form id="chat-form" class="chat-input-form">
            <div class="chat-input-container">
                <textarea 
                    id="chat-input" 
                    placeholder="Message EcoAgent..." 
                    rows="1" 
                    required
                ></textarea>
                <button type="submit" class="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="chat-input-footer">
                <span class="input-tip">
                    <i class="fas fa-lightbulb"></i>
                    Tip: Ask about your energy usage, carbon footprint, or ways to be more sustainable
                </span>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    let isProcessing = false;

    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = (chatInput.scrollHeight) + 'px';
    });

    // Handle form submission
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const message = chatInput.value.trim();
        if (!message || isProcessing) return;
        
        isProcessing = true;
        
        // Add user message to chat
        addMessage('user', message);
        chatInput.value = '';
        chatInput.style.height = 'auto';
        
        // Show typing indicator
        const typingIndicator = addTypingIndicator();
        
        try {
            // Send to backend
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query_type: 'chat',
                    message: message
                })
            });
            
            const data = await response.json();
            
            // Remove typing indicator
            typingIndicator.remove();
            
            if (data.status === 'success' && data.message) {
                addMessage('assistant', data.message);
            } else {
                addMessage('assistant', 'I apologize, but I encountered an error. Please try again.');
            }
        } catch (error) {
            console.error('Chat error:', error);
            typingIndicator.remove();
            addMessage('assistant', 'Sorry, there was an error processing your request.');
        }
        
        isProcessing = false;
    });

    function addTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'message assistant typing';
        indicator.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(indicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return indicator;
    }

    // Configure marked options for safe rendering
    marked.setOptions({
        breaks: true,  // Convert \n to <br>
        gfm: true,     // Enable GitHub Flavored Markdown
        sanitize: false, // Disable sanitization as we'll use DOMPurify
        highlight: function(code, lang) {
            return `<pre><code class="language-${lang}">${code}</code></pre>`;
        }
    });

    function addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Process content with Markdown if it's from the assistant
        const processedContent = role === 'assistant' ? marked.parse(content) : content;
        
        if (role === 'assistant') {
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">EcoAgent</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text markdown-body">${processedContent}</div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">You</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${processedContent}</div>
                </div>
            `;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
});
</script>
{% endblock %}
